#!/usr/bin/env node
const resolvePackagePath = require('resolve-package-path');
const semver = require('semver');
const chalk = require('chalk');
//const semver = require('semver');

const Path = require('path');

function spawnLocal(localBin, argv) {
    console.info(chalk.gray('Switching to local version'));
    const children = require('child_process');
    const result = children.spawnSync(localBin, [...argv].slice(2), { stdio: 'inherit' });
    process.exit(result.status);
}

function checkVersions(currentPkg, localPkg) {
    const currentVersion = semver.parse(currentPkg.version);
    const localVersion = semver.parse(localPkg.version);

    switch (currentVersion.compare(localVersion)) {
        case 1:
            console.warn(chalk.yellow(`The project's cli ${chalk.white(`[${localVersion.version}]`)} is older that the gobal ${chalk.white(`[${currentVersion.version}]`)}. 
Consiger updating using \`${chalk.white('npm i -D @doptools/cli@latest')}\` or \`${chalk.white('yarn add -D @doptools/cli@latest')}\``));
            break;
        case -1:
            console.warn(chalk.yellow(`The project's cli ${chalk.white(`[${localVersion.version}]`)} is newer that the gobal ${chalk.white(`[${currentVersion.version}]`)}. 
Consiger updating using \`${chalk.white('npm i -g @doptools/cli@latest')}\` or \`${chalk.white('yarn global add @doptools/cli@latest')}\``));
            break;
    }
}

function execute(argv) {
    require('@oclif/command').run(argv)
        .then(require('@oclif/command/flush'))
        .catch(require('@oclif/errors/handle'));
}

(function main(argv) {
    argv = argv.slice(2);
    const runGlobal = !!(argv[0] === 'global' ? argv.shift() : '');
    const localCli = !runGlobal ? resolvePackagePath('@doptools/cli', process.cwd()) : null;
    if (localCli !== null) {
        const cliRoot = Path.dirname(localCli);
        const localPkg = require(localCli);
        const localBin = Path.join(cliRoot, localPkg.bin.dops);
        if (localBin !== __filename) {
            const currentPkg = require(Path.join(__dirname, '..', 'package.json'));
            checkVersions(currentPkg, localPkg);
            spawnLocal(localBin, argv);
        }
    }
    execute(argv);
})(process.argv);



